# RnD-Service: Получатель и Конвертер Курсов Валют

![Go](https://img.shields.io/badge/Go-1.24.1-blue.svg) ![Docker](https://img.shields.io/badge/Docker-Supported-brightgreen.svg) ![Gin](https://img.shields.io/badge/Gin-Web%20Framework-orange.svg) ![PostgreSQL](https://img.shields.io/badge/PostgreSQL-Database-blueviolet.svg) ![Cron](https://img.shields.io/badge/Cron-Scheduling-yellow.svg)

## Описание

RnD-Service — это надежный, масштабируемый микросервис на Go, предназначенный для получения, хранения и предоставления курсов обмена валют от Центрального Банка России (ЦБ РФ). Он служит backend-API для приложений по конвертации валют, поддерживая запросы реального времени и исторических курсов. Сервис интегрируется с PostgreSQL для хранения данных, использует Gin для HTTP-маршрутизации и включает запланированные обновления через cron-задачи.

Проект демонстрирует современные практики разработки на Go, включая чистую архитектуру (адаптеры, сервисы, use cases, обработчики), обработку ошибок, логирование с Logrus и всестороннее тестирование (юнит, интеграционное, E2E). Также включена простая веб-панель для ручного взаимодействия.

Основные функции:
- Получение ежедневных курсов валют от API ЦБ РФ.
- Хранение текущих и исторических курсов в PostgreSQL.
- API-эндпоинты для обновления курсов и запросов.
- Поддержка конвертации сумм в запросах.
- Автоматическое ежедневное обновление в 10:00 по московскому времени.
- Graceful shutdown и обработка сигналов.

Этот сервис идеален для финансовых приложений, дашбордов или любых систем, нуждающихся в надежных данных курсов от ЦБ РФ.

## Возможности

- **Получение и Хранение Курсов**: Автоматически получает и сохраняет курсы от ЦБ РФ, обрабатывая парсинг XML, конвертацию значений и пакетные вставки.
- **Исторические Курсы**: Поддержка запросов курсов за прошлые даты, с получением из БД или ЦБ РФ, если данных нет.
- **API-Эндпоинты**:
  - `GET /currency/rates`: Ручное обновление курсов от ЦБ РФ.
  - `GET /currency/rate?val=<code>&date=<YYYY-MM-DD>&amount=<float>`: Получение курса для кода валюты, с опциональной датой и суммой.
- **Планирование**: Ежедневные обновления через cron в 10:00 по Москве.
- **Панель Управления**: Простой HTML-интерфейс на `/` для конвертации и обновлений.
- **Обработка Ошибок**: Надежное логирование, управление транзакциями и грациозное завершение.
- **Тестирование**: Полное покрытие юнит-тестами для адаптеров/сервисов/use cases/обработчиков, плюс E2E-тесты с Testcontainers.
- **Конфигурация**: На основе YAML для БД, логирования и т.д.
- **Поддержка Docker**: Контейнеризация с Compose для легкого развертывания.

## Преимущества и Яркие Моменты

- **Производительность**: Эффективные пакетные операции, пулинг соединений (pgx) и таймауты для API ЦБ РФ.
- **Надежность**: Обработка кодировки Windows-1251 от ЦБ РФ, парсинг запятых в десятичных, ретраи для соединений с БД.
- **Масштабируемость**: Чистая многоуровневая архитектура позволяет легко расширять (например, добавить другие источники).
- **Безопасность**: Настроен CORS для локальной разработки; легко расширить.
- **Превосходство в Тестировании**: 100% покрытие в ключевых областях; E2E-тесты запускают изолированные контейнеры Postgres.
- **Современные Практики**: Использование Squirrel для построения SQL, Testify для утверждений, pgxmock для мокинга БД.
- **Удобство для Пользователя**: Веб-панель с конвертером, кнопками популярных валют и обратным отсчетом до следующего обновления.
- **Готовность к Open-Source**: Модульный код, без внешних зависимостей кроме стандартной библиотеки Go и проверенных библиотек.

Этот проект выделяется демонстрацией реального разработки сервиса на Go, от интеграции API до готовых к продакшену функций, таких как планирование и graceful shutdown.

## Установка

1. **Предварительные Требования**:
   - Go 1.24.1+
   - PostgreSQL 15+
   - Docker (опционально, для контейнеризированной установки)

2. **Клонирование Репозитория**:
   ```
   git clone https://github.com/yourusername/RnD-service.git
   cd RnD-service
   ```

3. **Установка Зависимостей**:
   ```
   go mod download
   ```

## Конфигурация

Конфигурация загружается из `config/config.yaml`. Пример:

```yaml
app:
  name: "RnD-service"
  port: "8080"

log:
  level: "debug"

postgres:
  host: "db"
  port: "5432"
  user: "postgres"
  password: "postgres"
  dbname: "currency"
  sslmode: "disable"
```

- **Переменные Окружения**: Переопределение через env (например, `POSTGRES_HOST=localhost`).
- **Логирование**: Уровни: debug, info, warn, error.

Для продакшена защищайте чувствительные значения (например, пароль БД) через env или менеджмент секретов.

## Запуск Приложения

### Локально

1. **Запуск PostgreSQL** (например, через Docker):
   ```
   docker run -d -p 5432:5432 --name postgres_db -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=currency postgres:15
   ```

2. **Запуск Миграций** (ручной или через инструмент вроде migrate):
   - Выполните SQL-скрипты из `migrations/` в вашей БД.

3. **Сборка и Запуск**:
   ```
   go build -o rnd-service ./cmd/api
   ./rnd-service
   ```

   - Доступ к API по `http://localhost:8080`.
   - Панель управления по `http://localhost:8080/`.

### С Docker Compose

1. **Сборка и Запуск**:
   ```
   docker compose up -d
   ```

   - API по `http://localhost:8080`.
   - БД по `localhost:5432` (пользователь/пароль: postgres).

2. **Остановка**:
   ```
   docker compose down
   ```

## Запуск Тестов

Тесты организованы по пакетам, с E2E в `test/`, требующим `-tags e2e`.

- **Все Тесты**:
  ```
  go test ./... -v
  ```

- **E2E-Тесты** (требует Docker для Testcontainers):
  ```
  go test -tags e2e -v ./test
  ```

- **Покрытие**:
  ```
  go test ./... -cover
  ```

Тесты включают моки для CBR и БД, обеспечивая изоляцию.

## Тестирование через Postman

В проекте есть файл `valutes.json` — это коллекция Postman для импорта и тестирования API. Импортируйте его в Postman для удобного запуска запросов.

- **Содержимое коллекции**: Включает запросы для обновления курсов (`GET /currency/rates`) и получения курсов (POST /currency/get с JSON-body).
- **Как использовать**:
  1. Откройте Postman.
  2. Импортируйте `valutes.json` как коллекцию.
  3. Запускайте запросы для тестирования (обновление, получение курсов, обработка ошибок).

## Использование

- **Обновление Курсов**: `curl http://localhost:8080/currency/rates`
- **Получение Курса**: `curl "http://localhost:8080/currency/rate?val=USD&date=2023-01-12&amount=100"`
  - Ответ: `{"char_name":"USD","value_rub":6902.02}`

Панель Управления: Используйте UI для конвертации и обновлений.

## AI Assistants

В разработке проекта активно использовались AI-инструменты для ускорения и улучшения процесса:
- Тесты сформированы с помощью кодогенерации mockgen + Grok AI.
- README-файл создан с помощью Grok AI.
- Проведена работа над ошибками (рефакторинг, улучшение кода, структурированное логирование, оптимизация) с помощью Grok AI.

## Вклад

Форкните, создайте ветку, закоммитьте изменения и отправьте PR. Следуйте конвенциям Go.

## Лицензия

Лицензия MIT. Смотрите [LICENSE](LICENSE) для деталей.

---

Создано с ❤️ AngelCareMe. По вопросам открывайте issue!